{"version":3,"sources":["../src/branch.js"],"names":[],"mappings":"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","file":"branch.js","sourcesContent":["import { fromJS, is, Map, List} from \"immutable\";\nimport debug from \"debug\";\nimport util from 'util';\nimport Slots from \"./slots\";\nconst d = debug(\"slt\");\nconst log = debug(\"slt:log\");\n\nfunction isFunction(v) {\n    return Object.prototype.toString.call(v) === \"[object Function]\";\n}\n\nfunction isPromise(v) {\n    return isFunction(v.then);\n}\n\nfunction isImmutable(v) {\n    return isFunction(v.toJS);\n}\n\nfunction isArray(v) {\n    return Object.prototype.toString.call(v) === \"[object Array]\";\n}\n\nfunction isString(v) {\n    return Object.prototype.toString.call(v) === \"[object String]\";\n}\n\nfunction toJS(v) {\n    return v && isImmutable(v) && v.toJS() || v;\n}\n\nfunction insp(value) {\n    value = isImmutable(value) ? value.toJS() : value;\n    value = isArray(value) ? value.join(\".\") : value;\n    value = isFunction(value.then) ? \"__promise__\" : value;\n    return util.inspect(value, {colors: typeof window === \"undefined\", depth: 0}).replace('\\n', '');\n}\n\nclass Branch {\n    constructor(rules, state, ctx, parent = null) {\n        this.rules = rules;\n        this.state = state;\n        this.ctx = ctx;\n        this.parent = parent;\n        this.children = [];\n        this.promises = [];\n    }\n\n    reset() {\n        this.state = this.initialState;\n        this.promises = [];\n    }\n\n    newBranch(state) {\n        let branch = new Branch(this.rules, state, this.ctx, this);\n        this.children.push(branch);\n        return branch;\n    }\n\n    setState(value) {\n        return this.set([], value);\n    }\n\n    set(path = [], value = {}) {\n        ({path, value} = this.reducePathAndValue(Slots.path(path), value));\n        log(\"SET %s TO %s\", insp(path), insp(value));\n        let imValue = fromJS(value);\n        let result = imValue.toJS ? this.state.mergeDeepIn(path, imValue)\n            : this.state.setIn(path, imValue);\n        d(\"MERGED \\n%s\", insp(result));\n        const applyRules = (path = new List(), value = new Map()) => {\n            let rule = this.rules.get(path.toArray().join(\".\"));\n            if (isFunction(rule)) {\n                let val = result.getIn(path);\n                log(\"RULE on path %s matched with value %s\", insp(path), insp(val));\n                let branch = rule.call(this.newBranch(result), toJS(val));\n                if (isPromise(branch)) {\n                    log(\"PROMISE RETURNED\");\n                    branch.bind(this.ctx); // out of call stack\n                } else {\n                    d(\"NEW BRANCH with state %s\", insp(result));\n                    result = branch.getState();\n                    d(\"RESULT is %s\", insp(result));\n                }\n            }\n            if (!Map.isMap(value)) {\n                return;\n            }\n            value.flip().toList().map((k) => applyRules(path.push(k), value.get(k)));\n        };\n        applyRules(new List(path), result);\n        this.state = result;\n        return this;\n    }\n\n    reducePathAndValue(path, value) {\n        let i = path.length;\n        let v = value;\n        while (i--) {\n            let p = path.slice(0, i);\n            let tmp = {};\n            tmp[path.slice(i)] = v;\n            v = tmp;\n            if (this.rules.get(p.join(\".\"))) {\n                path = p;\n                value = v;\n            }\n        }\n        return { path, value }\n    }\n\n    getState() {\n        return this.state;\n    }\n\n    get(path = null, state = null) {\n        state = state || this.state;\n        if (!path) {\n            return state.toJS();\n        }\n        path = Slots.path(path);\n        let value = state.getIn(path);\n        return value && isImmutable(value) && value.toJS() || value;\n    }\n}\n\nexport default Branch;"]}